# Okra-Ax介绍


## 基本流程

client -> 登录服务器(login) -> 负载服务器(gate)

 1. 向登录服务器请求访问授权

```
|--------->GUEST_LOGIN
		|--------auth----->LOGIN_AUTH
<-----auth------|
```

 2. 访问负载的网关服务器

|-------------auth---------------->GUEST_LOGIN
<---------------------------------|

 3. 请求和响应

|-------------Gpb.Request--------->服务接口
<-------------Gpb.Response--------|

 4. 服务器推送消息

<-------------Push----------------|



[协议结构]
见GpbD.proto文件


获取授权:

请求示例：
http://192.168.2.29:11000/?api=aaa&id=sdf12
返回：
{"auth":3407410,"host":"192.168.2.29","port":10001,"state":0,"uid":377317571428353}


HTTP参数解释:
 1. id为玩家的机器码，或者其他字符串 - 客户端生成，用于向服务器获取uid
 2. 服务器返回玩家的唯一ID（uid）， 客户端保存记录uid - 用于重复访问资源使用
 3. 目前没有接入账号系统， 所以丢失uid=丢失玩家数据
 4. 目前api没啥卵用，只有一个id，用于负载均衡算法

## 2. [*]客户端-服务端通信协议
###2.1 客户端协议
相关的协议的接口协议码为10000-19999
###2.3 GpbD.proto
通信协议格式的结构内容，详细见GpbD.proto.
客户端和服务端通信流程见上方Request-Response通信流程

```
Request {
    id      int     客户请求的唯一ID - 客户端维护 - 用于服务器响应回调
    cmd     int     客户端请求访问的接口号
    data    byte[]  接口参数(二进制数据)	方便扩展各种自定义序列号和反序列化协议
}
Response {
    id      int     客户请求的唯一ID - 客户端维护 - 用于服务器响应回调
    data    byte[]  服务端响应的数据
    error   Error   服务器返回异常信息
}
Error {
    state   int     异常码-区别各种不同的异常
    msg     string  服务端携带的错误提示信息 - 不为空时 - 建议提示服务端返回的信息
}
```
Push是特殊的Response，是服务端主动推送给客户端的消息.

Response.data是Push结构的数据。
当客户端的回调列表中不存在Response.id对应的信息时，可以认定本消息为Push

Notify[暂时]

--------------------------------------------------------------------------------------

## 3. Ax内部通信协议
###3.1 Ax分布式结构
使用Gate-Remote模型, Gate负责均衡用户负载, Remote负责提供逻辑服务.


###3.2 Ax.proto
内部协议独立且区别于外部（客户端-服务端的协议）.
```
AxInbound {
    rid     int     内部客户组件生成的请求id - 用于响应回调
    source  long    请求方的标识id - 组件转发时
    cmd     int     内部接口号
    data    byte[]  请求参数
}
AxOutbound {
	rid	int		内部客户组件生成的请求id - 用于响应回调
	target	List<long>	广播的目标列表
	data	byte[]		响应的数据
	error	AxError		内部错误
}
AxError类似于GpbD.Error
```


## 4. 接口协议
根据具体实际的功能和服务，订立具体的协议结构和通信流程





[5. 协议]
[method:10003] 内部协议转发
[method:10004] 进入房间
[method:10005] 获取大厅列表[一个大厅包含多个桌子，  桌子=room]
[method:10006] 游客登录

[api:20001]	进入象棋房间
[api:20002]	移动棋子
[api:20003]	获取桌子列表
[api:21000]	退出房间（投降）

